<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <TargetFramework>net5.0</TargetFramework>
        <RestorePackagesWithLockFile>true</RestorePackagesWithLockFile>
        <RestoreLockedMode Condition="'$(CI)' == 'true'">true</RestoreLockedMode>
        <!--<CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>-->
        <EnableDynamicLoading>true</EnableDynamicLoading>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
        <LangVersion>9</LangVersion>
        <Nullable>enable</Nullable>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="KeraLua" Version="1.3.3"/>
        <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="2.1.0"/>
        <PackageReference Include="NLua" Version="1.6.0"/>
        <PackageReference Include="Shoko.Plugin.Abstractions" Version="2.4.0-alpha3">
            <ExcludeAssets>runtime</ExcludeAssets>
        </PackageReference>
    </ItemGroup>

    <Target Name="UpdateAssemblyInfo" BeforeTargets="BeforeBuild">
        <Exec Command="git describe --match=&quot;v[0-9]%2A&quot; --abbrev=0 --tags --always" ConsoleToMSBuild="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="GitVerTag"/>
        </Exec>
        <WriteLinesToFile File="AssemblyInfo.cs" Lines="$([System.Text.RegularExpressions.Regex]::Replace($([System.IO.File]::ReadAllText('AssemblyInfo.cs')), '(\d+)\.(\d+)\.(\d+)[\.(\d+)]%2A', $(GitVerTag.Substring(1,5))))" Overwrite="true" Encoding="utf-8"/>
    </Target>

    <Target Name="PackageForRelease" AfterTargets="AfterBuild">
        <ItemGroup>
            <LuaOut Include="lua/**/*.*"/>
            <WindowsOut Include="$(OutDir)runtimes/win-x64/native/lua54.dll"/>
            <LinuxOut Include="docker_build/liblua54.so"/>
            <SharedOut Include="$(OutDir)LuaRenamer.*;$(OutDir)KeraLua.dll;$(OutDir)NLua.dll" Exclude="$(OutDir)LuaRenamer.run*;$(OutDir)LuaRenamer.deps*"/>
        </ItemGroup>
        <Copy SourceFiles="@(WindowsOut);@(SharedOut)" DestinationFolder="$(OutDir)WindowsOut" SkipUnchangedFiles="true"/>
        <Copy SourceFiles="@(LinuxOut);@(SharedOut)" DestinationFolder="$(OutDir)LinuxOut" SkipUnchangedFiles="true"/>
        <Copy SourceFiles="@(LuaOut)" DestinationFolder="$(OutDir)WindowsOut/lua/%(LuaOut.RecursiveDir)" SkipUnchangedFiles="true"/>
        <Copy SourceFiles="@(LuaOut)" DestinationFolder="$(OutDir)LinuxOut/lua/%(LuaOut.RecursiveDir)" SkipUnchangedFiles="true"/>

        <ZipDirectory SourceDirectory="$(OutDir)WindowsOut" DestinationFile="$(OutDir)LuaRenamer_$(GitVerTag)_Win.zip" Overwrite="true"/>
        <ZipDirectory SourceDirectory="$(OutDir)LinuxOut" DestinationFile="$(OutDir)LuaRenamer_$(GitVerTag)_Linux.zip" Overwrite="true"/>
    </Target>
</Project>
